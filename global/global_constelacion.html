<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Constelación global</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background-color: #0b0f14;
    color: #e6edf3;
    overflow: hidden;
  }
  #graph {
    position: absolute;
    top: 0; left: 0; right: 300px; bottom: 0;
  }
  #sidebar {
    position: absolute;
    top: 0; right: 0; bottom: 0;
    width: 300px;
    background: #111821;
    border-left: 1px solid #222;
    padding: 10px;
    overflow-y: auto;
  }
  #searchBox {
    position: absolute;
    top: 10px; left: 10px;
    width: 250px;
    padding: 5px;
    border: none;
    border-radius: 4px;
  }
  .node circle {
    stroke: #111;
    stroke-width: 1.2px;
  }
  .node text {
    font-size: 11px;
    pointer-events: none;
  }
  .link {
    stroke: #94a3b8;
    stroke-opacity: .45;
    pointer-events: none;
  }
  .link.mentions {
    stroke: #9aa4b2;
    stroke-opacity: .55;
  }
  .link.belongs {
    stroke: #8ea2d8;
    stroke-opacity: .65;
    stroke-dasharray: 3 2;
  }
  .legend {
    position: absolute;
    bottom: 10px;
    left: 10px;
    font-size: 13px;
    background: #0e1520;
    padding: 6px 10px;
    border-radius: 8px;
  }
  .legend div {
    margin: 3px 0;
  }
  .legend span {
    display: inline-block;
    width: 14px; height: 14px;
    margin-right: 6px;
    vertical-align: middle;
    border-radius: 50%;
  }
  .bar {
    position: absolute;
    bottom: 0; left: 0; right: 300px;
    background: #0e1520;
    font-size: 12px;
    text-align: center;
    padding: 3px;
  }
  .bar a { color: #9fb3ff; text-decoration: none; }
</style>
</head>
<body>

<input id="searchBox" type="text" placeholder="Buscar…">

<div id="graph"></div>
<div id="sidebar"><h3>Contexto</h3><div id="contexto"></div></div>
<div class="legend">
  <div><span style="background:#2e7d32"></span>Pensamiento y conocimiento</div>
  <div><span style="background:#6a1b9a"></span>Contexto socio-histórico</div>
  <div><span style="background:#c62828"></span>Personales y biográficas</div>
  <div><span style="background:#ef6c00"></span>Culturales y artísticas</div>
  <hr>
  <div>→ autor <em>menciona</em> referencia</div>
  <div>→ referencia <em>pertenece a</em> categoría</div>
</div>
<div class="bar"><a href="https://www.youtube.com/" target="_blank">Ver entrevistas en YouTube</a></div>

<script>
const width = window.innerWidth - 300, height = window.innerHeight;

// Colores de grupos
const colorMap = {
  "Pensamiento y conocimiento": "#2e7d32",
  "Contexto socio-histórico": "#6a1b9a",
  "Personales y biográficas": "#c62828",
  "Culturales y artísticas": "#ef6c00",
  "autor": "#e6edf3"
};

// SVG principal
const svg = d3.select("#graph").append("svg")
  .attr("width", width)
  .attr("height", height);

const linkG = svg.append("g").attr("class","links");
const nodeG = svg.append("g").attr("class","nodes");

// Definir flechas
const defs = svg.append("defs");
function makeArrow(id, color){
  const m = defs.append("marker")
    .attr("id", id)
    .attr("viewBox", "0 -5 10 10")
    .attr("refX", 12)
    .attr("refY", 0)
    .attr("markerWidth", 7)
    .attr("markerHeight", 7)
    .attr("orient", "auto");
  m.append("path")
    .attr("d","M0,-5L10,0L0,5")
    .attr("fill", color)
    .attr("opacity", .95);
}
makeArrow("arrow-mentions", "#b8c0cc");
makeArrow("arrow-belongs", "#9fb3ff");

// Cargar datos
Promise.all([
  d3.csv("global_nodos.csv"),
  d3.csv("global_aristas.csv")
]).then(([nodes, edges])=>{
  const nodeById = new Map(nodes.map(d => [d.id, d]));
  edges.forEach(d => {
    d.source = nodeById.get(d.source);
    d.target = nodeById.get(d.target);
  });

  // Simulación
  const sim = d3.forceSimulation(nodes)
    .force("link", d3.forceLink(edges).id(d=>d.id).distance(80).strength(0.7))
    .force("charge", d3.forceManyBody().strength(-220))
    .force("center", d3.forceCenter(width/2, height/2))
    .force("collision", d3.forceCollide().radius(d=>radius(d)+4));

  // Enlaces
  const link = linkG.selectAll("line")
    .data(edges)
    .enter().append("line")
    .attr("class", d => "link " + (d.relation==="belongs_to" ? "belongs" : "mentions"))
    .attr("stroke-width", d => d.relation==="belongs_to"?1.8:1.4)
    .attr("marker-end", d => d.relation==="belongs_to" ? "url(#arrow-belongs)" : "url(#arrow-mentions)");

  // Nodos
  const node = nodeG.selectAll("g")
    .data(nodes)
    .enter().append("g")
    .attr("class","node")
    .call(d3.drag()
      .on("start",dragstarted)
      .on("drag",dragged)
      .on("end",dragended));

  node.append("circle")
    .attr("r", radius)
    .attr("fill", d => color(d));

  node.append("text")
    .text(d=>d.label)
    .attr("dy",3)
    .attr("x", d=>radius(d)+4)
    .style("font-size","10px");

  // Click -> mostrar contexto
  node.on("click", (e,d)=>{
    document.getElementById("contexto").innerText = d.note || "(sin contexto)";
  });

  // Simulación tick con recorte de líneas
  sim.on("tick", ()=>{
    link.each(function(d){
      const sx = d.source.x, sy = d.source.y, tx = d.target.x, ty = d.target.y;
      const dx = tx - sx, dy = ty - sy;
      const dist = Math.hypot(dx, dy) || 1;
      const nx = dx/dist, ny = dy/dist;

      const rSource = radius(d.source);
      const rTarget = radius(d.target);

      const x1 = sx + nx*(rSource+1);
      const y1 = sy + ny*(rSource+1);
      const x2 = tx - nx*(rTarget+3);
      const y2 = ty - ny*(rTarget+3);

      d3.select(this).attr("x1",x1).attr("y1",y1).attr("x2",x2).attr("y2",y2);
    });

    node.attr("transform", d=>`translate(${d.x},${d.y})`);
  });

  // Buscar
  document.getElementById("searchBox").addEventListener("input", function(){
    const term = this.value.toLowerCase();
    node.style("opacity", d => d.label.toLowerCase().includes(term)?1:0.15);
    link.style("opacity", d => (d.source.label.toLowerCase().includes(term) || d.target.label.toLowerCase().includes(term)) ? 0.9 : 0.05);
  });
});

// Funciones auxiliares
function radius(d){
  if(d.type==="categoria") return 16;
  if(d.type==="autor") return 12;
  return 8;
}
function color(d){
  if(d.type==="categoria") return colorMap[d.label] || "#888";
  if(d.type==="autor") return colorMap["autor"];
  return colorMap[d.group] || "#ccc";
}
function dragstarted(e,d){
  if(!e.active) d.fy = d.y, d.fx = d.x;
}
function dragged(e,d){
  d.fx = e.x; d.fy = e.y;
}
function dragended(e,d){
  if(!e.active){ d.fx=null; d.fy=null; }
}
</script>
</body>
</html>
